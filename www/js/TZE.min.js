/*!
 * Script für TZE (0.1.0) - Erstellt am 21-07-2015
 *
 * Copyright (c) 2015, Johannes Boost <jjjb at usw-tools.de>
 * 
 * Lizenziert unter: Creative Commons Lizenzvertrag - CC-BY-NC-SA-3.0
 * Namensnennung - Nicht-kommerziell - Weitergabe unter gleichen Bedingungen
 * http://creativecommons.org/licenses/by-nc-sa/3.0/de/legalcode
 */
var tickets=function(a){function b(a,b,c,d){var e=a.append(g.formgroup).children().last();return e.append(g.label).children().last().prop({"for":b,textContent:c+":"}),e.append(g.input).find("input").prop({id:b,type:d}),e.find("input")}function c(a){var b=a.wrapAll('<div class="input-group"></div>').parent();b.prepend(g.inputgroupbtn),b.children().first().append(g.button10+g.button5+g.button1)}function d(a,b,c,d){if(c>0){var e=void 0!==d?c+" "+d:c;a.text().length>0&&a.append(" | "),a.show().append('<span class="'+b+'">'+e+"</span>")}else a.append('<span name="'+b+'"></span>')}function e(b,c,d,e){var f=new RegExp('<div name="'+c+'".*?</div>',"gi"),g=a(b).data("title").replace(f,"");if(a(b).tooltip("destroy"),d>0){var h=void 0!==e?'<div name="'+c+'" class="text-left">'+e+':&nbsp;<span class="">'+d+"</span><br></div>":'<div name="'+c+'"><span>'+d+"</span></div>";a(b).data("title",h+g)}else a(b).data("title",g)}var f={},g={prompt:'<form class="form-horizontal"></form>',formgroup:'<div class="form-group"></div>',label:'<label class="col-sm-4 control-label"></label>',input:'<div class="col-sm-8"><input class="bootbox-input bootbox-input-number form-control" autocomplete=off /></div>',inputgroupbtn:'<span class="input-group-btn"></span>',button1:'<button class="btn btn-default" tabindex="-1" data-step="1" type="button">+1</button>',button5:'<button class="btn btn-default" tabindex="-1" data-step="5" type="button">+5</button>',button10:'<button class="btn btn-default" tabindex="-1" data-step="10" type="button">+10</button>'};return f.loadTickets=function(b){if(null!==b){a(document).off("keydown");var c=a("#Tickets");c.children().addClass("disabled");var f=c.siblings(".panel-heading");a("<span class='badge badge-primary'><span class='glyphicon glyphicon-refresh glyphicon-spin'></span></span>").appendTo(f),a.post("func/tickets.php",{action:"list",projektId:b},function(b){f.children().fadeOut("fast",function(){f.children().remove()}),"OK"===b.Result&&(a("#Tickets").empty(),null!==b.data&&a.each(b.data,function(b,c){var f="ticketId_"+c.ticketId,g=a('<a href="#" id="'+f+'" class="list-group-item">'+c.ticketName+"</a>");g.data({ticket:c,html:!0,toggle:"tooltip",placement:"top",delay:{show:500,hide:100}}),null!==c.shortcut&&(g.data({title:'<div class="text-left">Tastenkürzel:&nbsp;<span class="">'+c.shortcut+"</span></div>"}),a(document).on("keydown",function(b){var d=1===b.key.length?b.key.toUpperCase():String.fromCharCode(b.keyCode);d===c.shortcut.toUpperCase()&&(a(".bootbox").length||(b.preventDefault(),g.click()))}));var h=a('<span class="badge badge-default absolute-right-15 nonOpaqueOnHover"></span>').hide().appendTo(g);c.durationSwitch>1&&d(h,"duration",c.duration,"Min."),c.counterSwitch>1&&e(g,"counter",c.counter,c.counterName),null!==c.tickets&&d(h,"tickets",c.tickets),g.tooltip().appendTo("#Tickets")}))},"json")}},f.updateTicket=function(b,c,f){var g=b.data("ticket"),h=g.ticketId,i=b.children("span.badge"),j=a(".bootbox .btn-primary"),k=(j.html(),{action:"new",ticketId:h});return a.each(c,function(){"checkbox"===a(this).prop("type")?k[this.id]=!this.checked:this.value&&(k[this.id]=this.value)}),a.ajax({url:"func/tickets.php",method:"POST",data:k,dataType:"json",async:"false",beforeSend:function(){j.addClass("disabled").parent().prepend("<span class='wait text-muted'><span class='glyphicon glyphicon-refresh glyphicon-spin'></span>&nbsp;Senden...</span>&nbsp;")},success:function(h){j.removeClass("disabled").siblings("span.wait").remove(),"OK"===h.Result?(a.extend(b.data("ticket"),h.data),b.tooltip("destroy"),i.empty(),g.durationSwitch>1&&d(i,"duration",g.duration,"Min."),g.counterSwitch>1&&e(b,"counter",g.counter,g.counterName),null!==g.tickets&&d(i,"tickets",g.tickets),f.modal("hide"),setTimeout(function(){b.tooltip()},500)):"ERROR"===h.Result&&c.each(function(){this.id===h.errorIn&&a(this).data({animation:!1,content:h.Message,trigger:"manual",container:"body",toggle:"popover"}).popover("show")})},error:function(){bootbox.error("Übertragung fehlgeschlagen!")}}),!1},f.init=function(){a(document).on("click","button[data-step]",function(){var b=this,c=a(b).data("step"),d=a(b).closest(".input-group").children("input");d[0].value=Number(d[0].value)+c}),a("#Tickets").on("click","a:not(.disabled)",function(){var d=a(this),e=d.data("ticket"),h=a(g.prompt);if(e.ticketNumberSwitch>1){var i=b(h,"ticketNumber","Ticketnummer","number");e.ticketNumberSwitch>2&&i.prop({required:!0})}if(e.counterSwitch>1){var j=b(h,"counter",e.counterName,"number");j.prop({autofocus:!0}),c(j),e.counterSwitch>2&&j.prop({required:!0})}if(e.durationSwitch>1){var k=b(h,"duration","Dauer","number");c(k),e.counterSwitch>2&&k.prop({required:!0})}e.undoneSwitch>0&&b(h,"undone","Abgeschlossen","checkbox"),a(document).one("shown.bs.modal",function(){var b=a(".bootbox").find("input[autofocus]");b.first().focus()}),f.dialogBox=bootbox.confirm({title:"Neues Ticket ["+e.ticketName+"]",animate:!1,message:h,callback:function(b){if(a(".popover").popover("destroy"),b){d.tooltip("hide");var c=!1,e=a(this).find("input");return e.each(function(){this.required&&(this.value||(a(this).data({animation:!1,content:"Angabe fehlt!",trigger:"manual",container:"body",toggle:"popover"}).popover("show"),c=!0))}),c||f.updateTicket(d,e,f.dialogBox),!1}}}),a(f.dialogBox).on("keydown",function(b){var c=b.which||b.keyCode;if(e.counterSwitch>1&&(107===c||187===c)){b.preventDefault();var d=a("#counter"),f=d.val();f++,d.val(f)}13===c&&(b.preventDefault(),a(this).find(".btn-primary:not(.disabled)").click())})})},f}(jQuery),timetable=function(){var a,b={};return b.loadTimes=function(){return $.get("func/times.php",function(a){$("#AZ_Total").removeClass("clockme").text(a.AZ_Total.time).parent().addClass("disabled"),$("#PZ_Total").removeClass("clockme").text(a.PZ_Total.time).parent().addClass("disabled"),"1"==a.AZ_Total.clockme&&$("#AZ_Total").addClass("clockme").parent().removeClass("disabled"),"1"==a.PZ_Total.clockme&&$("#PZ_Total").addClass("clockme").parent().removeClass("disabled")},"json")},b.initTimetable=function(){$("#timetable").jtable({title:"Zeiterfassung",fields:{id:{key:!0,list:!1},iProjekt:{list:!1},Projekt:{width:"50%",title:"Projekt",display:function(a){return""!==a.record.ListLabel?a.record.Projekt+" - "+a.record.ListLabel:a.record.Projekt}},iCat:{list:!1},"class":{list:!1},ListLabel:{list:!1},Time_Start:{title:"Anfang",display:function(a){return a.record.Time_Start.substr(-8,5)}},Time_End:{title:"Ende",display:function(a){return a.record.Time_End.substr(-8,5)}},Duration:{title:"Dauer",display:function(a){var b="";return"0000-00-00 00:00:00"===a.record.Time_End&&(b="clockme"),'<time class="'+b+'">'+a.record.Duration.substr(-8)+"</time>"}}},actions:{listAction:function(){return $.Deferred(function(a){$.ajax({url:"func/timetable.php",type:"POST",dataType:"json",data:{action:"getList"},success:function(c){"OK"===c.Result&&(c.Records=c.Records||[],console.log("Recived Records: "+c.Records.length),tickets.loadTickets(c.lastProj),b.projectButtons.set(c.lastProj),b.timeButtons.set(c.lastCat)),a.resolve(c)},error:function(){a.reject()}})})}}}),this.loadTimetable()},b.loadTimetable=function(){$("#timetable").jtable("load")},b.timetableInsert=function(a){$("#timetable").jtable("addRecord",{animationsEnabled:!1,clientOnly:!0,record:a})},b.timetableUpdate=function(a){$("#timetable [data-record-key="+a.id+"]").length>0?$("#timetable").jtable("updateRecord",{animationsEnabled:!1,clientOnly:!0,record:a}):b.timetableInsert(a)},b.timeButtons={set:function(a){return $("#buttons_projects").removeData("savedVal"),$("#buttons_times").data("timeCat",a),this.activate(a)},activate:function(a){return void 0!==a&&a>0?(this.enable(),$("#buttons_times").children("a").each(function(){$(this).data("timeCat")===a?$(this).addClass("active"):$(this).removeClass("active")})):(b.projectButtons.set(),void this.disable())},reset:function(){return $("#buttons_times").children("a").removeClass("active")},enable:function(){return $("#buttons_times").children("a").removeClass("disabled")},disable:function(){return $("#buttons_times").data("timeCat",void 0).children("a").addClass("disabled").removeClass("active")},load:function(){return $.post("index.php",{action:"getTimes"},function(a){if("OK"===a.Result){var b=$("#buttons_times").empty();$.each(a.Data,function(){var a=$('<a href="#">'+this.ButtonLabel+"</a>").addClass(this["class"]).addClass("list-group-item").data("timeCat",this.id);b.append(a)})}},"json")}},b.projectButtons={set:function(a){$("#buttons_projects").removeData("savedVal");var b=this.activate(a);return b},activate:function(a){return b.timeButtons.enable(),$("#buttons_projects").data("projCat",a).children("a").each(function(){$(this).data("projCat")===a?$(this).addClass("active"):$(this).removeClass("active")})},enable:function(){return $("#buttons_projects").children("a").removeClass("disabled")},disable:function(){return $("#buttons_projects").data("projCat","0").children("a").addClass("disabled").removeClass("active")},reset:function(){return $("#buttons_projects").children("a").removeClass("active")},load:function(){return $.post("index.php",{action:"getProjects"},function(a){"OK"===a.Result&&($("#buttons_projects").empty(),$.each(a.Data,function(){$("#buttons_projects").append('<a href="#">'+this.ButtonLabel+"</a>").children().last().addClass("list-group-item").data("projCat",this.id)}))},"json")}},b.init=function(){var b=this;b.savedVal=$("#buttons_projects").data("savedVal"),$.when(b.projectButtons.load(),b.timeButtons.load(),b.loadTimes()).then(function(){b.initTimetable(),$(".m-app-loading").fadeOut(function(){$(".m-app-loading").remove()})}),$("#buttons_projects").on("click","a:not(.disabled)",function(c){c.preventDefault(),clearTimeout(a);var d=$(this).data("projCat"),e=$("#buttons_projects").data("projCat"),f=$("#buttons_times").data("timeCat"),g=$("#buttons_projects").data("savedVal");0===g||void 0===g?$("#buttons_projects").data("savedVal",{projCat:e,timeCat:f}):(e=g.projCat,f=g.timeCat),d===e?(b.projectButtons.set(e),b.timeButtons.set(f)):(b.projectButtons.activate(d),b.timeButtons.reset(),b.timeButtons.enable(),a=setTimeout(function(){b.projectButtons.set(e),b.timeButtons.set(f),tickets.loadTickets(e)},7e3)),tickets.loadTickets(d)}),$("#buttons_times").on("click","a:not(.disabled)",function(c){function d(a,b,c){$.active>0?$(document).one("ajaxStop",function(){d(a,b,c)}):$.ajax({url:"func/timetable.php",method:"POST",data:a,dataType:"json",success:function(a){e(a,b)},error:function(){bootbox.error("Übertragung fehlgeschlagen!")},complete:function(){c.removeClass("disabled").siblings("span.wait").remove()}})}function e(a,c){c.modal("hide"),"OK"===a.Result?($.each(a.Data,function(){b.timetableUpdate(this)}),b.loadTimes(),0===f?(b.timeButtons.disable(),b.projectButtons.reset()):(b.projectButtons.set(h),b.timeButtons.set(f))):(b.projectButtons.set(i),b.timeButtons.set(g),tickets.loadTickets(i),void 0!==a.Message&&bootbox.alert({title:"Fehler",message:a.Message,callback:function(){void 0!==a.Goto&&(window.location.href=a.Goto)}}))}if(c.preventDefault(),!$("body").hasClass("modal-open")){clearTimeout(a);var f=$(this).data("timeCat"),g=$("#buttons_times").data("timeCat"),h=$("#buttons_projects").data("projCat"),i=$("#buttons_projects").data("projCat"),j=$("#buttons_projects").data("savedVal");if(void 0===j?$("#buttons_projects").data("savedVal",{projCat:i,timeCat:g}):(i=j.projCat,g=j.timeCat),f!==g||h!==i){clearTimeout(a);var k=$(this).text(),l=$("#buttons_projects a.active").text(),m="Du wechselst auf "+l+" - "+k+"!";b.dialogBox=bootbox.confirm({message:m,animate:!1,callback:function(a){if(a){var c=$(".bootbox .modal-footer button");return c.addClass("disabled").parent().prepend("<span class='wait text-muted'><span class='glyphicon glyphicon-refresh glyphicon-spin'></span>&nbsp;Senden...</span>&nbsp;"),d({action:"TimeStamp",ProjektID:h,TimeClassID:f},b.dialogBox,c),!1}b.projectButtons.set(i),b.timeButtons.set(g),tickets.loadTickets(i)}})}}})},b}();$(document).ready(function(){timetable.init(),tickets.init()});